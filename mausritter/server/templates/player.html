{% extends "base.html" %}

{% block title %}{{ character.name }} - Mausritter{% endblock %}

{% block extra_styles %}
.character-sheet {
    max-width: 900px;
    margin: 0 auto;
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.sheet-header {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 20px;
}

.name-box {
    border: 2px solid #4a4a5a;
    border-radius: 8px;
    padding: 15px 20px;
}

.name-row {
    display: flex;
    align-items: center;
    gap: 15px;
    margin-bottom: 12px;
    padding-bottom: 12px;
    border-bottom: 1px solid #e0e0e0;
}

.field-label {
    font-weight: bold;
    font-size: 1.2em;
    color: #4a4a5a;
    min-width: 100px;
}

.field-input {
    flex: 1;
    border: none;
    background: transparent;
    font-size: 1em;
    color: #6a6a7a;
    padding: 5px;
}

.field-input:focus {
    outline: none;
    background: #f8f8f8;
    border-radius: 4px;
}

.appearance-box {
    border: 2px solid #4a4a5a;
    border-radius: 8px;
    padding: 15px 20px;
}

.appearance-grid {
    display: grid;
    grid-template-columns: 100px 1fr;
    gap: 8px;
    align-items: center;
}

.stats-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 15px;
    margin-bottom: 25px;
}

.stat-card {
    border: 2px solid #4a4a5a;
    border-radius: 8px;
    padding: 15px;
    text-align: center;
}

.stat-name {
    font-weight: bold;
    font-size: 1.1em;
    color: #4a4a5a;
    margin-bottom: 10px;
}

.stat-values {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
}

.stat-current-input {
    width: 50px;
    font-size: 1.5em;
    font-weight: bold;
    text-align: center;
    border: 2px solid #d0d0d0;
    border-radius: 6px;
    padding: 5px;
}

.stat-current-input:focus {
    outline: none;
    border-color: #4a4a5a;
}

.stat-max {
    font-size: 1.2em;
    color: #888;
}

.inventory-section {
    border: 2px solid #4a4a5a;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 25px;
}

.inventory-section h2 {
    margin-bottom: 15px;
}

.inventory-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
}

.slot-group h3 {
    font-size: 0.9em;
    color: #6a6a7a;
    margin-bottom: 10px;
    text-transform: uppercase;
}

.slot {
    background: #f5f5f5;
    border: 1px solid #d0d0d0;
    border-radius: 6px;
    padding: 10px;
    margin-bottom: 8px;
    min-height: 40px;
}

.slot-input {
    width: 100%;
    border: none;
    background: transparent;
    font-size: 0.95em;
    padding: 2px;
}

.slot-input:focus {
    outline: none;
    background: white;
}

.slot-empty {
    color: #aaa;
    font-style: italic;
}

.bottom-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 25px;
}

.info-box {
    border: 2px solid #4a4a5a;
    border-radius: 8px;
    padding: 15px;
}

.info-box h3 {
    font-size: 1em;
    margin-bottom: 10px;
}

.info-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.info-label {
    font-weight: bold;
    color: #4a4a5a;
}

.info-input {
    width: 60px;
    text-align: center;
    border: 1px solid #d0d0d0;
    border-radius: 4px;
    padding: 5px;
}

.conditions-box {
    margin-bottom: 25px;
}

.conditions-box h3 {
    margin-bottom: 10px;
}

.conditions-list {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.condition-tag {
    background: #ffeeee;
    color: #c44;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.9em;
}

.no-conditions {
    color: #aaa;
    font-style: italic;
}

.notes-section {
    margin-bottom: 25px;
}

.notes-section h3 {
    margin-bottom: 10px;
}

.notes-textarea {
    width: 100%;
    min-height: 100px;
    border: 2px solid #d0d0d0;
    border-radius: 8px;
    padding: 15px;
    font-size: 1em;
    resize: vertical;
}

.notes-textarea:focus {
    outline: none;
    border-color: #4a4a5a;
}

.dice-section {
    border: 2px solid #4a4a5a;
    border-radius: 8px;
    padding: 20px;
    background: #f9f9f9;
}

.dice-section h3 {
    margin-bottom: 15px;
}

.dice-input-row {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
}

.dice-input {
    flex: 1;
    padding: 10px;
    font-size: 1.1em;
    border: 2px solid #d0d0d0;
    border-radius: 6px;
}

.dice-result {
    background: white;
    padding: 15px;
    border-radius: 6px;
    min-height: 50px;
    text-align: center;
    font-size: 1.3em;
    font-weight: bold;
}

.save-indicator {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #4a7a4a;
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    opacity: 0;
    transition: opacity 0.3s;
}

.save-indicator.show {
    opacity: 1;
}
{% endblock %}

{% block content %}
<div class="character-sheet">
    <div class="sheet-header">
        <div class="name-box">
            <div class="name-row">
                <span class="field-label blackletter">Name</span>
                <input type="text" class="field-input" id="name" value="{{ character.name }}" data-field="name">
            </div>
            <div class="name-row" style="border-bottom: none; margin-bottom: 0; padding-bottom: 0;">
                <span class="field-label">Background</span>
                <input type="text" class="field-input" id="background" value="{{ character.background }}" data-field="background">
            </div>
        </div>
        <div class="appearance-box">
            <div class="appearance-grid">
                <span class="field-label">Birthsign</span>
                <input type="text" class="field-input" value="{{ character.appearance.birthsign }}" data-field="appearance.birthsign">
                <span class="field-label">Coat</span>
                <input type="text" class="field-input" value="{{ character.appearance.coat }}" data-field="appearance.coat">
                <span class="field-label">Look</span>
                <input type="text" class="field-input" value="{{ character.appearance.look }}" data-field="appearance.look">
            </div>
        </div>
    </div>

    <div class="stats-section">
        <div class="stat-card">
            <div class="stat-name">STR</div>
            <div class="stat-values">
                <input type="number" class="stat-current-input" value="{{ character.attributes.STR.current }}"
                       data-field="attributes.STR.current" data-max="{{ character.attributes.STR.max }}" min="0" max="{{ character.attributes.STR.max }}">
                <span class="stat-max">/ {{ character.attributes.STR.max }}</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-name">DEX</div>
            <div class="stat-values">
                <input type="number" class="stat-current-input" value="{{ character.attributes.DEX.current }}"
                       data-field="attributes.DEX.current" data-max="{{ character.attributes.DEX.max }}" min="0" max="{{ character.attributes.DEX.max }}">
                <span class="stat-max">/ {{ character.attributes.DEX.max }}</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-name">WIL</div>
            <div class="stat-values">
                <input type="number" class="stat-current-input" value="{{ character.attributes.WIL.current }}"
                       data-field="attributes.WIL.current" data-max="{{ character.attributes.WIL.max }}" min="0" max="{{ character.attributes.WIL.max }}">
                <span class="stat-max">/ {{ character.attributes.WIL.max }}</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-name">HP</div>
            <div class="stat-values">
                <input type="number" class="stat-current-input" value="{{ character.hp.current }}"
                       data-field="hp.current" data-max="{{ character.hp.max }}" min="0" max="{{ character.hp.max }}">
                <span class="stat-max">/ {{ character.hp.max }}</span>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-name">Pips</div>
            <div class="stat-values">
                <input type="number" class="stat-current-input" value="{{ character.pips }}"
                       data-field="pips" min="0" max="250">
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-name">Grit</div>
            <div class="stat-values">
                <input type="number" class="stat-current-input" value="{{ character.grit }}"
                       data-field="grit" min="0" max="10">
            </div>
        </div>
    </div>

    <div class="inventory-section">
        <h2>Inventory</h2>
        <div class="inventory-grid">
            <div class="slot-group">
                <h3>Paws</h3>
                <div class="slot">
                    <input type="text" class="slot-input" placeholder="Main paw"
                           value="{{ character.inventory.main_paw }}" data-field="inventory.main_paw">
                </div>
                <div class="slot">
                    <input type="text" class="slot-input" placeholder="Off paw"
                           value="{{ character.inventory.off_paw }}" data-field="inventory.off_paw">
                </div>
            </div>
            <div class="slot-group">
                <h3>Body</h3>
                {% for i in range(2) %}
                <div class="slot">
                    <input type="text" class="slot-input" placeholder="Body slot {{ i + 1 }}"
                           value="{{ character.inventory.body[i] }}" data-field="inventory.body.{{ i }}">
                </div>
                {% endfor %}
            </div>
            <div class="slot-group">
                <h3>Pack</h3>
                {% for i in range(6) %}
                <div class="slot">
                    <input type="text" class="slot-input" placeholder="Pack slot {{ i + 1 }}"
                           value="{{ character.inventory.pack[i] }}" data-field="inventory.pack.{{ i }}">
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="bottom-section">
        <div class="info-box">
            <h3>Progress</h3>
            <div class="info-row">
                <span class="info-label">Level</span>
                <input type="number" class="info-input" value="{{ character.level }}" data-field="level" min="1">
            </div>
            <div class="info-row">
                <span class="info-label">XP</span>
                <input type="number" class="info-input" value="{{ character.xp }}" data-field="xp" min="0">
            </div>
        </div>
        <div class="info-box">
            <h3>Banked</h3>
            <div class="info-row">
                <span class="info-label">Pips</span>
                <input type="number" class="info-input" value="{{ character.banked.pips }}" data-field="banked.pips" min="0">
            </div>
        </div>
    </div>

    <div class="conditions-box">
        <h3>Conditions</h3>
        <div class="conditions-list">
            {% if character.conditions %}
                {% for condition in character.conditions %}
                <span class="condition-tag">{{ condition }}</span>
                {% endfor %}
            {% else %}
                <span class="no-conditions">No conditions</span>
            {% endif %}
        </div>
    </div>

    <div class="notes-section">
        <h3>Notes</h3>
        <textarea class="notes-textarea" data-field="notes" placeholder="Character notes...">{{ character.notes }}</textarea>
    </div>

    <div class="dice-section">
        <h3>Dice Roller</h3>
        <div class="dice-input-row">
            <input type="text" class="dice-input" id="dice-input" placeholder="e.g., 2d6+3, 1d20">
            <button class="btn" onclick="rollDice()">Roll</button>
        </div>
        <div class="dice-result" id="dice-result">-</div>
    </div>
</div>

<div class="save-indicator" id="save-indicator">Saved!</div>
{% endblock %}

{% block extra_scripts %}
const characterId = '{{ character.id }}';
let saveTimeout = null;

// Auto-save on field change
document.querySelectorAll('[data-field]').forEach(input => {
    input.addEventListener('change', () => saveField(input));
    input.addEventListener('blur', () => saveField(input));
});

async function saveField(input) {
    const field = input.dataset.field;
    let value = input.type === 'number' ? parseInt(input.value) || 0 : input.value;

    // Enforce max value constraint for stats
    if (input.dataset.max) {
        const maxValue = parseInt(input.dataset.max);
        if (value > maxValue) {
            value = maxValue;
            input.value = maxValue;
        }
    }

    // Build nested update object from field path
    const parts = field.split('.');
    let data = {};
    let current = data;

    for (let i = 0; i < parts.length - 1; i++) {
        const part = parts[i];
        const nextPart = parts[i + 1];

        // Check if next part is a number (array index)
        if (!isNaN(parseInt(nextPart))) {
            current[part] = current[part] || [];
        } else {
            current[part] = current[part] || {};
        }
        current = current[part];
    }

    const lastPart = parts[parts.length - 1];
    if (!isNaN(parseInt(lastPart))) {
        // Array index - need special handling
        // Get the parent array field and rebuild the whole array
        const arrayField = parts.slice(0, -1).join('.');
        const arrayInputs = document.querySelectorAll(`[data-field^="${arrayField}."]`);
        const arrayValues = [];
        arrayInputs.forEach(inp => {
            const idx = parseInt(inp.dataset.field.split('.').pop());
            arrayValues[idx] = inp.value;
        });

        // Rebuild data object for array update
        data = {};
        current = data;
        for (let i = 0; i < parts.length - 2; i++) {
            current[parts[i]] = {};
            current = current[parts[i]];
        }
        current[parts[parts.length - 2]] = arrayValues;
    } else {
        current[lastPart] = value;
    }

    const result = await apiPatch(`/characters/${characterId}`, data);
    if (result.success) {
        showSaveIndicator();
    }
}

function showSaveIndicator() {
    const indicator = document.getElementById('save-indicator');
    indicator.classList.add('show');
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(() => {
        indicator.classList.remove('show');
    }, 1500);
}

// Dice roller
function rollDice() {
    const input = document.getElementById('dice-input').value.trim();
    const result = document.getElementById('dice-result');

    if (!input) {
        result.textContent = '-';
        return;
    }

    try {
        const total = parseDiceNotation(input);
        result.textContent = total;
    } catch (e) {
        result.textContent = 'Invalid dice notation';
    }
}

function parseDiceNotation(notation) {
    // Parse notation like "2d6+3" or "1d20-2"
    const pattern = /(\d+)d(\d+)([+-]\d+)?/gi;
    let total = 0;
    let match;
    let matched = false;

    while ((match = pattern.exec(notation)) !== null) {
        matched = true;
        const numDice = parseInt(match[1]);
        const sides = parseInt(match[2]);
        const modifier = match[3] ? parseInt(match[3]) : 0;

        for (let i = 0; i < numDice; i++) {
            total += Math.floor(Math.random() * sides) + 1;
        }
        total += modifier;
    }

    if (!matched) {
        // Try parsing as plain number
        const num = parseInt(notation);
        if (!isNaN(num)) return num;
        throw new Error('Invalid notation');
    }

    return total;
}

// Roll on Enter key
document.getElementById('dice-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') rollDice();
});
{% endblock %}
